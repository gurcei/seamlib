#OUTPUT "SEAMLIB"'--------.DECLARES'--------#DECLARE FIDX, FRAMEØCOUNT%, ANIMØCOUNT#DECLARE BKPØD054&, BKPØD058&, BKPØD059&, BKPØD05E&#DECLARE MYØERR$, K, IDX, X, Y, VALUE' FRAME DETAILS#DECLARE DEFAULTØSLICE(100), CHARØTYPE(100), CHARØIDX%(100)#DECLARE CHRØWIDTH%(100), CHRØHEIGHT%(100)#DECLARE BBØTLX(100,10), BBØTLY(100,10), BBØBRX(100,10), BBØBRY(100,10)#DECLARE BBØCNT(100)#DECLARE OLDØFIDX' SPRITE DETAILS#DECLARE SPRØCHRØWIDTH%(100), SPRØCHRØHEIGHT%(100), SPRØCHARØIDX%(100)#DECLARE SPRØFRAMEØCOUNT%(100), SPRØFRAMES%(100,20), SPRØVISIBLE%(100)#DECLARE SPRØFIDX%(100), STAGEØXØOFFS%(100), SPRØCOUNT#DECLARE SPRØOX%(100), SPRØOY%(100)#DECLARE OBJX, OBJY, OLDYY, MINYY, MAXYY, YYBOT #DECLARE A$, YY, OFFSY, TMP, TMPX, TMPY#DECLARE TCLR, TX, TY, REVØFLAG, CHR#DECLARE LN$, CHARØCOUNT, XX, KK, SIDX, OLDØSIDX, ANIMØTMR'-------.DEFINES'-------#DEFINE À≈ŸØ≈”√¡–≈ = CHR$(27)#DEFINE À≈ŸØ“≈÷ØœŒ = ""#DEFINE À≈ŸØ“≈÷Øœ∆∆ = "í"#DEFINE À≈ŸØ’– = "ë"#DEFINE À≈ŸØƒœ◊Œ = ""#DEFINE À≈ŸØÃ≈∆‘ = "ù"#DEFINE À≈ŸØ“…«»‘ = ""#DEFINE À≈ŸØÕ≈«¡Ø— = "´"#DEFINE ◊…ƒ‘» = 250#DEFINE œ–Ø√œ–Ÿ = 0#DEFINE œ–ØÕ…ÿ  = 1#DEFINE œ–Ø”◊¡– = 2#DEFINE œ–Ø∆…ÃÃ = 3#DEFINE …Œ÷¡Ã…ƒ = -666' SEAM FRAMES#DEFINE ∆Ø√¡“–≈‘ = 0#DEFINE ∆Ø◊œÃ∆1 = 1#DEFINE ∆ØÀ≈Ÿ = 2#DEFINE ∆Ø¬¡Œ¡Œ¡ = 3#DEFINE ∆Ø◊¬œ‘‘Ã≈ = 4#DEFINE ∆Ø◊œÃ∆2 = 5' SEAM SPRITES#DEFINE ”Ø√¡“–≈‘ = 0#DEFINE ”ØÀ≈Ÿ = 1#DEFINE ”Ø¬¡Œ¡Œ¡ = 2#DEFINE ”Ø◊¬œ‘‘Ã≈ = 3#DEFINE ”Ø◊œÃ∆1 = 4#DEFINE ”Ø◊œÃ∆2 = 5#DEFINE ”Ø◊œÃ∆3 = 6#DEFINE ”Ø◊œÃ∆4 = 7SPRØCOUNT = 8TRAP RUNSTOPØTRAPPER'----.MAIN'----  GOSUB INIT  GOSUB CLRSCREEN  FOR SIDX = 0 TO SPRØCOUNT - 1    GOSUB STAGEØOBJECT  NEXT SIDX  SIDX = 0  GOSUB USERØINPUT  END'----.INIT'----  BANK 0  BLOAD "GAME.PAL",P($FFD3100)  LN$ = "MOANA3.BIN"  GOSUB LOADØDATA  BLOAD "ASMHELPER"  BANK 128  KEY OFF  ' PREPARE VARS FOR ASSEMBLY  WPOKE $1600, POINTER(SPRØOX%(0))  WPOKE $1602, POINTER(SPRØOY%(0))  WPOKE $1604, POINTER(SPRØCHRØWIDTH%(0))  WPOKE $1606, POINTER(SPRØCHRØHEIGHT%(0))  WPOKE $1608, POINTER(SPRØCHARØIDX%(0))  WPOKE $160A, POINTER(STAGEØXØOFFS%(0))  POKE $160C, SPRØCOUNT  ' PREPARE SPRITE DETAILS  SPRØCHRØWIDTH%(”Ø√¡“–≈‘) = 3  SPRØCHRØHEIGHT%(”Ø√¡“–≈‘) = 3  SPRØCHARØIDX%(”Ø√¡“–≈‘) = CHARØIDX%(∆Ø√¡“–≈‘)  SPRØFRAMEØCOUNT%(”Ø√¡“–≈‘) = 1  SPRØFRAMES%(”Ø√¡“–≈‘, 0) = ∆Ø√¡“–≈‘  SPRØCHRØWIDTH%(”ØÀ≈Ÿ) = 1  SPRØCHRØHEIGHT%(”ØÀ≈Ÿ) = 1  SPRØCHARØIDX%(”ØÀ≈Ÿ) = CHARØIDX%(∆ØÀ≈Ÿ)  SPRØFRAMEØCOUNT%(”ØÀ≈Ÿ) = 1  SPRØFRAMES%(”ØÀ≈Ÿ, 0) = ∆ØÀ≈Ÿ  SPRØCHRØWIDTH%(”Ø¬¡Œ¡Œ¡) = 2  SPRØCHRØHEIGHT%(”Ø¬¡Œ¡Œ¡) = 2  SPRØCHARØIDX%(”Ø¬¡Œ¡Œ¡) = CHARØIDX%(∆Ø¬¡Œ¡Œ¡)  SPRØFRAMEØCOUNT%(”Ø¬¡Œ¡Œ¡) = 1  SPRØFRAMES%(”Ø¬¡Œ¡Œ¡, 0) = ∆Ø¬¡Œ¡Œ¡  SPRØCHRØWIDTH%(”Ø◊¬œ‘‘Ã≈) = 3  SPRØCHRØHEIGHT%(”Ø◊¬œ‘‘Ã≈) = 3  SPRØCHARØIDX%(”Ø◊¬œ‘‘Ã≈) = CHARØIDX%(∆Ø◊¬œ‘‘Ã≈)  SPRØFRAMEØCOUNT%(”Ø◊¬œ‘‘Ã≈) = 1  SPRØFRAMES%(”Ø◊¬œ‘‘Ã≈, 0) = ∆Ø◊¬œ‘‘Ã≈  FOR K = 0 TO 3    SPRØCHRØWIDTH%(”Ø◊œÃ∆1 + K) = 4    SPRØCHRØHEIGHT%(”Ø◊œÃ∆1 + K) = 4    SPRØCHARØIDX%(”Ø◊œÃ∆1 + K) = CHARØIDX%(∆Ø◊œÃ∆1)    SPRØFRAMEØCOUNT%(”Ø◊œÃ∆1 + K) = 2    SPRØFRAMES%(”Ø◊œÃ∆1 + K, 0) = ∆Ø◊œÃ∆1    SPRØFRAMES%(”Ø◊œÃ∆1 + K, 1) = ∆Ø◊œÃ∆2  NEXT K    FOR K = 0 TO SPRØCOUNT - 1    SPRØOX%(K) = K * 6 * 8    SPRØOY%(K) = 10 * 8  NEXT K  ' HARD-CODING A FEW VALUES THAT WILL BE VARIABLE IN FUTURE  FIDX = 0  OLDYY = …Œ÷¡Ã…ƒ  PRINT "ì";À≈ŸØ≈”√¡–≈;"5";    BKPØD054& = PEEK($D054)  BKPØD058& = PEEK($D058)  BKPØD059& = PEEK($D059)  BKPØD05E& = PEEK($D05E)  ' SET ”≈¡Õ MODE √»“16 + ∆√Ã“»…  SETBIT $D054, 0  SETBIT $D054, 2  WPOKE $D058, ◊…ƒ‘»  POKE $D05E, ◊…ƒ‘» / 2  POKE $D021, 14  POKE $D020, 0  ' $1000 = SOLID FCM CHAR  FOR K = 0 TO 63    POKE $40000 + K, $FF  NEXT K  ' $1001 = BOX CHAR  FOR K = 0 TO 63    IF INT(K / 8) = 0 OR INT(K / 8) = 7 THEN POKE $40040 + K, $FF:GOTO NXT    IF MOD(K, 8) = 0 OR MOD(K, 8) = 7 THEN POKE $40040 + K, $FF:GOTO NXT    POKE $40040 + K, $00.NXT  NEXT K  ' $1002 = TL BOX  IDX = 0  FOR Y = 0 TO 7    FOR X = 0 TO 7    VALUE = $FF    IF Y = 0 THEN VALUE = $01    IF X = 0 THEN VALUE = $01    IF Y = 7 AND X = 7 THEN VALUE = $01    POKE $40080 + IDX, VALUE    IDX = IDX + 1    NEXT X  NEXT Y  ' $1003 = T BOX  IDX = 0  FOR Y = 0 TO 7    FOR X = 0 TO 7      VALUE = $FF      IF Y = 0 THEN VALUE = $01      IF Y = 7 AND X = 7 THEN VALUE = $01      POKE $400C0 + IDX, VALUE      IDX = IDX + 1    NEXT X  NEXT Y  ' $1004 = L BOX  IDX = 0  FOR Y = 0 TO 7    FOR X = 0 TO 7      VALUE = $FF      IF X = 0 THEN VALUE = $01      IF Y = 7 AND X = 7 THEN VALUE = $01      POKE $40100 + IDX, VALUE      IDX = IDX + 1    NEXT X  NEXT Y  ' $1005 = M BOX  IDX = 0  FOR Y = 0 TO 7    FOR X = 0 TO 7      VALUE = $FF      IF Y = 7 AND X = 7 THEN VALUE = $01      POKE $40140 + IDX, VALUE      IDX = IDX + 1    NEXT X  NEXT Y  ' $1006 = L LINE  IDX = 0  FOR Y = 0 TO 7    FOR X = 0 TO 7      VALUE = $00      IF X = 0 THEN VALUE = $01      POKE $40180 + IDX, VALUE      IDX = IDX + 1    NEXT X  NEXT Y  ' $1007 = T LINE  IDX = 0  FOR Y = 0 TO 7    FOR X = 0 TO 7      VALUE = $00      IF Y = 0 THEN VALUE = $01      POKE $401C0 + IDX, VALUE      IDX = IDX + 1    NEXT X  NEXT Y  RETURN'---------------.RUNSTOPØTRAPPER'---------------  ' IF ER<>30 THEN RESUME  ' IGNORE EVERYTHING EXCEPT RUN/STOP  MYØERR$ = "?" + ERR$(ER) + " IN LINE " + STR$(EL).CLEANUP  PRINT "ì";MYØERR$  TRAP  POKE $D054, BKPØD054&  POKE $D058, BKPØD058&  POKE $D059, BKPØD059&  POKE $D05E, BKPØD05E&  KEY ON  END'---------.CLRSCREEN'---------  EDMA œ–Ø∆…ÃÃ, ◊…ƒ‘» * 50, 32, $40800  EDMA œ–Ø∆…ÃÃ, ◊…ƒ‘» * 50, 0, $FF80000  ' CLEAR SCREEN  FOR Y = 0 TO 49   FOR X = 0 TO 79     POKE $40800 + Y * ◊…ƒ‘» + X * 2 + 1, 0   NEXT X  NEXT Y  RETURN'------------.STAGEØOBJECT'------------  IF SIDX > 0 THEN BEGIN    STAGEØXØOFFS%(SIDX) = STAGEØXØOFFS%(SIDX-1) + SPRØCHRØWIDTH%(SIDX-1) + 1  BEND  FOR Y = 0 TO 49    ' PREPARE INITIAL GOTOX CHAR    POKE $FF80000 + Y * ◊…ƒ‘» + 160 + STAGEØXØOFFS%(SIDX) * 2, %10010000    WPOKE $40800 + Y * ◊…ƒ‘» + 160 + STAGEØXØOFFS%(SIDX) * 2, 80 * 8  ' KEEP OFF-SCREEN INITIALLY    ' PREPARE ENDING GOTOX CHAR    POKE $FF80000 + Y * ◊…ƒ‘» + 160 + STAGEØXØOFFS%(SIDX) * 2 + (SPRØCHRØWIDTH%(SIDX) + 1) * 2, %10010000    WPOKE $40800 + Y * ◊…ƒ‘» + 160 + STAGEØXØOFFS%(SIDX) * 2 + (SPRØCHRØWIDTH%(SIDX) + 1) * 2, 80 * 8  NEXT Y  GOSUB DRAWØOBJECT  RETURN'----------.USERØINPUT'----------  DO WHILE 1    ' GOSUB DRAWØCOORDS    GOSUB DRAWØOBJECTS    GOSUB ANIMATEØOBJECTS    GET A$    IF A$ = À≈ŸØÃ≈∆‘ THEN SPRØOX%(SIDX) = SPRØOX%(SIDX) - 1    IF A$ = À≈ŸØ“…«»‘ THEN SPRØOX%(SIDX) = SPRØOX%(SIDX) + 1    IF A$ = À≈ŸØ’– THEN SPRØOY%(SIDX) = SPRØOY%(SIDX) - 1    IF A$ = À≈ŸØƒœ◊Œ THEN SPRØOY%(SIDX) = SPRØOY%(SIDX) + 1    IF A$ = À≈ŸØÕ≈«¡Ø— THEN GOTO CLEANUP    IF A$ = "," AND SIDX > 0 THEN SIDX = SIDX - 1    IF A$ = "." AND SIDX < SPRØCOUNT - 1 THEN SIDX = SIDX + 1  LOOP  RETURN'---------------.ANIMATEØOBJECTS'---------------  ANIMØTMR = MOD (ANIMØTMR + 1, 8)  IF ANIMØTMR = 0 THEN BEGIN    FOR K = 0 TO 3      FIDX = SPRØFIDX%(”Ø◊œÃ∆1 + K)      FIDX = MOD(FIDX + 1, 2)      SPRØFIDX%(”Ø◊œÃ∆1 + K) = FIDX      TMP = CHARØIDX%(SPRØFRAMES%(”Ø◊œÃ∆1 + K, FIDX))      SPRØCHARØIDX%(”Ø◊œÃ∆1 + K) = TMP    NEXT K  BEND  RETURN'-----------.DRAWØCOORDS'-----------  TCLR = 0 : TX = 5 : TY = 4  A$ = "SPRITE INDEX =" + STR$(SIDX)  GOSUB DRAWØTEXT  TCLR = 0 : TX = 5 : TY = 5  A$ = "X =" + STR$(SPRØOX%(SIDX)) + ", Y =" + STR$(SPRØOY%(SIDX)) + "     "  GOSUB DRAWØTEXT  RETURN'------------.DRAWØOBJECTS'------------  VSYNC 250  BORDER 3BANK 0^^  SYS TO $1610, I1  BANK 128  RETURN  ' ‘œƒœ: REMOVE BELOW ONCE SYS CALL ABOVE WORKS  OLDØSIDX = SIDX  FOR SIDX = 0 TO SPRØCOUNT - 1    GOSUB DRAWØOBJECT  NEXT SIDX  SIDX = OLDØSIDX  RETURN'-----------.DRAWØOBJECT'-----------'  BANK 0'  WPOKE $1600, SPRØOX%(FIDX)'  WPOKE $1602, SPRØOY%(FIDX)'  POKE $1604, CHRØWIDTH%(FIDX)'  POKE $1605, CHRØHEIGHT%(FIDX)'  WPOKE $1606, CHARØIDX%(FIDX)'  WPOKE $1608, STAGEØXØOFFS%(FIDX)'  POKE $160A, FRAMEØCOUNT%'  BANK 128 : BORDER 7 : BANK 0  OBJX = SPRØOX%(SIDX)  OBJY = SPRØOY%(SIDX)  VSYNC 250  BORDER 3  YY = INT(OBJY / 8)  YYBOT = YY + CHRØHEIGHT%(FIDX) ' - 1  OFFSY = MOD(OBJY, 8)  ' CLEAR PRIOR POSITION (IF NEEDBE)  IF OLDYY <> …Œ÷¡Ã…ƒ AND YY <> OLDYY THEN BEGIN    MINYY = OLDYY    MAXYY = OLDYY + CHRØHEIGHT%(FIDX) ' - 1    IF MINYY < YY AND YY < MAXYY THEN MAXYY = YY - 1    IF MINYY < YYBOT AND YYBOT < MAXYY THEN MINYY = YYBOT + 1    ' HIDE THESE ROWS OFF-SCREEN    FOR Y = MINYY TO MAXYY      WPOKE $40800 + Y * ◊…ƒ‘» + STAGEØXØOFFS%(FIDX) * 2 + 160, 80 * 8     NEXT Y  BEND  VSYNC 250  BORDER 2  ' DRAW CHARS ON DESIRED YROWS, AND AT RIGHT OBJX POSITION  IDX = CHARØIDX%(FIDX)  TMPX = CHRØWIDTH%(FIDX) - 1  TMPY = CHRØHEIGHT%(FIDX) - 1  FOR X = 0 TO TMPX    FOR Y = 0 TO TMPY      K = $40800 + (YY + Y) * ◊…ƒ‘» + STAGEØXØOFFS%(FIDX) * 2 + 162 + X * 2      WPOKE K, IDX      ' COPY LAST Y-LINE AN EXTRA LINE BELOW (TO HELP WITH Y SCROLLING)      IF Y = TMPY THEN BEGIN        WPOKE K + ◊…ƒ‘», IDX      BEND      IDX = IDX + 1    NEXT Y  NEXT X  ' HANDLE NEGATIVE X  X = OBJX  IF OBJX < 0 THEN X = 1024 + OBJX  K = X + (OFFSY * 32 + 16) * 256  ' SET INITIAL ROWMASK  TMP = $FF80000 + YY * ◊…ƒ‘» + STAGEØXØOFFS%(FIDX) * 2 + 160  POKE TMP, %10011000  POKE TMP + 1, 255 << OFFSY AND 255  ' SET INITIAL GOTOX CHAR  FOR Y = YY TO YY + TMPY    TMP = Y * ◊…ƒ‘» + STAGEØXØOFFS%(FIDX) * 2 + 160    IF Y <> YY THEN BEGIN      POKE $FF80000 + TMP, %10010000    BEND    WPOKE $40800 + TMP, K  NEXT Y  ' SET FINAL YOFFS  K = X + ( ((8-OFFSY) AND 7) * 32) * 256  WPOKE $40800 + YYBOT * ◊…ƒ‘» + STAGEØXØOFFS%(FIDX) * 2 + 160, K  ' SET FINAL ROWMASK  TMP = $FF80000 + YYBOT * ◊…ƒ‘» + STAGEØXØOFFS%(FIDX) * 2 + 160  POKE TMP, %10011000  POKE TMP + 1, 255 >> (8 - OFFSY) AND 255  OLDYY = YY  BORDER 0  RETURN'---------.DRAWØTEXT'---------  IDX = 0  REVØFLAG = 0  FOR K = 1 TO LEN(A$)    CHR = ASC(MID$(A$,K,1))    IF MID$(A$,K,1) = À≈ŸØ“≈÷ØœŒ THEN REVØFLAG = 1 : GOTO NXTDT    IF MID$(A$,K,1) = À≈ŸØ“≈÷Øœ∆∆ THEN REVØFLAG = 0 : GOTO NXTDT    GOSUB PETSCIIØTOØSCREENCODE    IF REVØFLAG = 1 THEN CHR = CHR OR $80    WPOKE $40800 + TY * ◊…ƒ‘» + (TX + IDX) * 2, CHR    POKE $FF80000 + TY * ◊…ƒ‘» + (TX + IDX) * 2 + 1, TCLR    IDX = IDX + 1.NXTDT  NEXT K  RETURN'---------------------.PETSCIIØTOØSCREENCODE'---------------------  IF CHR>=$00 AND CHR<=$1F THEN CHR = CHR OR $80 : RETURN  IF CHR>=$20 AND CHR<=$3F THEN RETURN  IF CHR>=$40 AND CHR<=$5F THEN CHR=CHR AND $BF : RETURN  IF CHR>=$60 AND CHR<=$7F THEN CHR=CHR AND $DF : RETURN  IF CHR>=$80 AND CHR<=$9F THEN CHR=CHR OR $40 : RETURN  IF CHR>=$A0 AND CHR<=$BF THEN CHR=(CHR AND $7F) OR $40 : RETURN  IF CHR>=$C0 AND CHR<=$FE THEN CHR=CHR AND $7F : RETURN  RETURN'---------.LOADØDATA'---------  CHARØCOUNT = 0  IF LEN(LN$) > 0 THEN BEGIN    DOPEN #2,(LN$),R,U8    IF DS THEN TCLR = 2 : A$ = "DISK ERROR" : GOSUB DRAWØTEXT : RETURN    GET#2, FRAMEØCOUNT%    FOR K = 0 TO FRAMEØCOUNT% - 1      GET#2, XX : CHARØTYPE(K) = XX AND 255      GET#2, XX : DEFAULTØSLICE(K) = XX AND 255      GET#2, XX : CHRØWIDTH%(K) = XX AND 255      GET#2, XX : CHRØHEIGHT%(K) = XX AND 255      GET#2, XX, YY      CHARØIDX%(K) = (XX AND 255) + (YY AND 255) * 256      GET#2, XX : BBØCNT(K) = XX AND 255      IF BBØCNT(K) > 0 THEN BEGIN        FOR KK = 0 TO BBØCNT(K) - 1          GET#2, XX, YY : BBØTLX(K,KK) = XX AND 255 : BBØTLY(K,KK) = YY AND 255          GET#2, XX, YY : BBØBRX(K,KK) = XX AND 255 : BBØBRY(K,KK) = YY AND 255        NEXT KK      BEND      CHARØCOUNT = CHARØCOUNT + CHRØWIDTH%(K) * CHRØHEIGHT%(K)    NEXT K    ' TODO : ADD ANIMATION DETAILS HERE    GET#2, XX : ANIMØCOUNT = XX AND 255    IF ANIMØCOUNT > 0 THEN BEGIN      FOR K = 0 TO ANIMØCOUNT - 1        ' LOAD NUMBER OF FRAMES IN ANIM        ' LOAD LIST OF FRAME INDICES      NEXT K    BEND    FOR K = 0 TO CHARØCOUNT * $40      GET#2, XX      POKE CHARØIDX%(0) * $40 + K, XX AND 255    NEXT K    DCLOSE #2  BEND  RETURN